# TASK-0004: Configure Visual Testing - Implementation Plan

## Objective
Set up visual regression testing framework for UI consistency using Alchemist, which provides cross-platform golden test consistency and enhanced testing capabilities essential for this MVP.

## Approach
We'll use **Alchemist** as the primary visual testing framework because:
- Cross-platform rendering consistency (critical for CI/CD)
- Automatic light/dark theme variants (required by TASK-0007)
- Reduced boilerplate for multiple UI states
- Better scalability for 15-20+ UI components planned in MVP
- Minimal additional setup time (~1 hour) with significant long-term benefits

## Implementation Steps

### 1. Install Alchemist
- Add `alchemist` package as dev dependency: `flutter pub add dev:alchemist`
- Verify installation by checking `pubspec.yaml`

### 2. Configure Alchemist
- Create `alchemist.yaml` configuration file in project root
- Configure golden test settings (platform normalization, output directories)
- Set up CI/CD integration settings

### 3. Create Directory Structure
- Create `test/golden/` directory for test files
- Alchemist will auto-generate golden images in appropriate directories
- Set up logical organization: `widgets/`, `screens/`, `components/`

### 4. Create First Alchemist Test
- Write initial test for a simple UI component
- Use `goldenTest` with multiple scenarios
- Test both light and dark themes automatically
- Test different widget states (empty, loading, with data)
- Validate golden generation workflow

### 5. Set up Golden Test Scripts
- Create convenience scripts for:
  - Generating new goldens: `flutter test --update-goldens --tags=golden`
  - Running golden tests: `flutter test --tags=golden`
  - Running specific test file: `flutter test test/golden/widgets/my_widget_test.dart --update-goldens`

### 6. Documentation
- Document Alchemist golden test best practices
- Create developer guide for:
  - Writing new golden tests with Alchemist
  - Creating test scenarios for multiple UI states
  - Updating goldens when UI changes intentionally
  - Troubleshooting golden test failures
  - Using Alchemist's cross-platform features

### 7. CI/CD Integration
- Alchemist handles cross-platform rendering automatically
- Store goldens in version control (Git)
- Configure CI to run golden tests: `flutter test --tags=golden`
- No platform-specific workarounds needed (Alchemist normalization)

## Technical Decisions

### Why Alchemist for This MVP
**Alchemist chosen as primary framework because:**
- **Cross-platform consistency**: Prevents platform-specific rendering issues in CI/CD
- **Light/Dark theme support**: Automatic variants match project requirements (TASK-0007)
- **Multiple UI states**: Essential for testing empty states, loading states, error states
- **Reduced boilerplate**: 50% less test code for same coverage
- **Future-proof**: Scales well with 15-20+ UI components planned in backlog
- **Minimal setup overhead**: Only ~1 hour additional setup vs standard golden tests
- **Better DX**: Automatic diff generation, clearer test structure

### Directory Structure
```
test/
├── golden/
│   ├── widgets/
│   │   └── widget_name_test.dart
│   ├── screens/
│   │   └── screen_name_test.dart
│   └── components/
│       └── component_name_test.dart
goldens/
├── ci/                          # Generated by Alchemist for CI
└── macos/                       # Generated by Alchemist for macOS
    ├── widgets/
    └── screens/
```

### File Naming Convention
- Test files: `{component_name}_test.dart` (in `test/golden/` subdirectories)
- Golden images: Auto-generated by Alchemist with naming pattern:
  - `{test_name}.{scenario_name}.{theme}.png`
  - Example: `transaction_card.with_data.light.png`

## Dependencies Required

```yaml
dev_dependencies:
  flutter_test:
    sdk: flutter
  alchemist: ^0.13.0
```

Add using:
```bash
flutter pub add dev:alchemist
```

## Alchemist Configuration File

Create `alchemist.yaml` in project root:

```yaml
theme_sets:
  - name: default
    themes:
      - name: light
        theme_data: ThemeData.light()
      - name: dark
        theme_data: ThemeData.dark()

platform_goldensConfig:
  enabled: true
  platforms:
    - name: ci
      device: Pixel6

golden_test_theme: defaultTheme
```

## Testing the Setup

### Validation Checklist
- [ ] Alchemist dependency added successfully
- [ ] `alchemist.yaml` configuration created
- [ ] First golden test runs successfully
- [ ] Goldens generate with `--update-goldens` flag
- [ ] Test fails when widget changes (regression detection works)
- [ ] Both light and dark themes automatically tested
- [ ] Golden images generated in correct directories
- [ ] Documentation is clear and complete

## Example First Test - Simple Widget

Create `test/golden/widgets/placeholder_card_test.dart`:

```dart
import 'package:alchemist/alchemist.dart';
import 'package:flutter/material.dart';

void main() {
  goldenTest(
    'PlaceholderCard displays correctly',
    fileName: 'placeholder_card',
    tags: ['golden'],
    builder: () => GoldenTestGroup(
      children: [
        GoldenTestScenario(
          name: 'empty_state',
          child: const SizedBox(
            width: 400,
            child: Card(
              child: Padding(
                padding: EdgeInsets.all(16.0),
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(Icons.inbox, size: 48),
                    SizedBox(height: 8),
                    Text('No items yet'),
                  ],
                ),
              ),
            ),
          ),
        ),
      ],
    ),
  );
}
```

This single test automatically generates:
- `placeholder_card.empty_state.light.png`
- `placeholder_card.empty_state.dark.png`

### Example with Multiple Scenarios

For future transaction list testing:

```dart
import 'package:alchemist/alchemist.dart';
import 'package:flutter/material.dart';

void main() {
  goldenTest(
    'TransactionCard variants',
    fileName: 'transaction_card',
    tags: ['golden'],
    builder: () => GoldenTestGroup(
      children: [
        GoldenTestScenario(
          name: 'debt_active',
          child: SizedBox(
            width: 400,
            child: TransactionCard(
              name: 'John Doe',
              amount: 1000.00,
              balance: 750.00,
              currency: 'PLN',
              type: TransactionType.debt,
            ),
          ),
        ),
        GoldenTestScenario(
          name: 'loan_overdue',
          child: SizedBox(
            width: 400,
            child: TransactionCard(
              name: 'Jane Smith',
              amount: 500.00,
              balance: 500.00,
              currency: 'EUR',
              type: TransactionType.loan,
              dueDate: DateTime(2024, 1, 1),
              isOverdue: true,
            ),
          ),
        ),
        GoldenTestScenario(
          name: 'completed',
          child: SizedBox(
            width: 400,
            child: TransactionCard(
              name: 'Bob Wilson',
              amount: 300.00,
              balance: 0.00,
              currency: 'USD',
              type: TransactionType.debt,
              isCompleted: true,
            ),
          ),
        ),
      ],
    ),
  );
}
```

This generates 6 golden images automatically:
- 3 scenarios × 2 themes (light + dark) = 6 goldens

## Risks and Mitigation

### Risk: Platform-Specific Rendering
**Mitigation:** Use consistent CI environment (Docker) or Alchemist's normalization

### Risk: Golden Tests Becoming Stale
**Mitigation:** Regular review process, clear update procedures in documentation

### Risk: Large Golden File Sizes
**Mitigation:** Optimize test widget sizes, use Git LFS if needed

## Success Criteria
- Visual testing framework configured and documented
- At least one working golden test example
- Developer documentation complete
- Team can generate and update goldens independently
- Foundation ready for UI component testing in future tasks

## Common Commands

### Generate goldens for the first time
```bash
flutter test --update-goldens --tags=golden
```

### Run golden tests (without updating)
```bash
flutter test --tags=golden
```

### Update specific test goldens
```bash
flutter test test/golden/widgets/placeholder_card_test.dart --update-goldens
```

### Run tests in CI mode
```bash
flutter test --tags=golden --dart-define=CI=true
```

## Estimated Complexity
**Low** - Straightforward setup with Alchemist, ~2-3 hours total including first test example

## Next Steps After Completion
Mark TASK-0004 as complete in backlog and proceed to TASK-0005 (Configure Localization)
