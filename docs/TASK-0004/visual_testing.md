# Visual Testing Guide - Alchemist

This document describes how to use Alchemist for visual regression testing in the Depts and Loans Register app.

## Overview

We use **Alchemist** for golden testing because it provides:
- Cross-platform rendering consistency (critical for CI/CD)
- Automatic light/dark theme variants
- Reduced boilerplate for testing multiple UI states
- Better scalability for UI components

## Directory Structure

```
test/
├── golden/
│   ├── widgets/          # Widget-level golden tests
│   │   ├── goldens/      # Generated golden images
│   │   └── *_test.dart   # Test files
│   ├── screens/          # Screen-level golden tests
│   └── components/       # Component-level golden tests
```

Golden images are automatically generated by Alchemist in subdirectories:
- `goldens/linux/` - For local development on Linux
- `goldens/ci/` - For CI/CD environment (normalized rendering)

## Configuration

The project is configured via `alchemist.yaml` in the project root:

```yaml
theme_sets:
  - name: default
    themes:
      - name: light
        theme_data: ThemeData.light()
      - name: dark
        theme_data: ThemeData.dark()

platform_goldensConfig:
  enabled: true
  platforms:
    - name: ci
      device: Pixel6

golden_test_theme: defaultTheme
```

## Writing Golden Tests

### Basic Test Structure

```dart
import 'package:alchemist/alchemist.dart';
import 'package:flutter/material.dart';

void main() {
  goldenTest(
    'Widget description',
    fileName: 'output_filename',
    tags: ['golden'],
    builder: () => GoldenTestGroup(
      children: [
        GoldenTestScenario(
          name: 'scenario_name',
          child: const SizedBox(
            width: 400,
            child: YourWidget(),
          ),
        ),
      ],
    ),
  );
}
```

### Testing Multiple Scenarios

Test different states of the same widget in a single test:

```dart
goldenTest(
  'TransactionCard variants',
  fileName: 'transaction_card',
  tags: ['golden'],
  builder: () => GoldenTestGroup(
    children: [
      GoldenTestScenario(
        name: 'empty_state',
        child: SizedBox(width: 400, child: EmptyTransactionCard()),
      ),
      GoldenTestScenario(
        name: 'with_data',
        child: SizedBox(width: 400, child: TransactionCard(data: mockData)),
      ),
      GoldenTestScenario(
        name: 'overdue',
        child: SizedBox(width: 400, child: TransactionCard(isOverdue: true)),
      ),
    ],
  ),
);
```

### Automatic Theme Variants

Alchemist automatically generates goldens for both light and dark themes based on the configuration in `alchemist.yaml`. Each scenario generates multiple images:
- `filename.scenario_name.light.png`
- `filename.scenario_name.dark.png`

Note: The current version of Alchemist generates combined images per platform rather than separate theme files.

## Common Commands

### Generate Golden Images (First Time)

```bash
flutter test --update-goldens --tags=golden
```

Use this when:
- Creating new golden tests
- Intentionally updating UI appearance
- Fixing visual regressions

### Run Golden Tests

```bash
flutter test --tags=golden
```

Tests will fail if the current widget appearance doesn't match the saved goldens.

### Update Specific Test Goldens

```bash
flutter test test/golden/widgets/placeholder_card_test.dart --update-goldens
```

### Run Tests in CI Mode

```bash
flutter test --tags=golden --dart-define=CI=true
```

## Best Practices

1. **Keep Tests Focused**: Each test should focus on a single widget or component
2. **Test Multiple States**: Include scenarios for empty, loading, error, and success states
3. **Use Consistent Sizing**: Wrap test widgets in `SizedBox` with explicit dimensions
4. **Tag All Golden Tests**: Always use `tags: ['golden']` for golden tests
5. **Descriptive Names**: Use clear, descriptive names for test files and scenarios
6. **Review Changes**: Always review golden image diffs before updating

## File Naming Conventions

- Test files: `{component_name}_test.dart`
- File name parameter: Use snake_case without `_test` suffix
- Scenario names: Use snake_case describing the state

Example:
```dart
// File: test/golden/widgets/transaction_card_test.dart
goldenTest(
  'TransactionCard displays correctly',
  fileName: 'transaction_card',  // Not 'transaction_card_test'
  // ...
);
```

## Troubleshooting

### Test Fails After UI Changes

This is expected behavior when you intentionally change UI. Review the changes and update goldens if correct:

```bash
flutter test test/golden/widgets/your_test.dart --update-goldens
```

### Platform-Specific Rendering Differences

Alchemist generates separate goldens for different platforms:
- Use `goldens/linux/` for local development
- Use `goldens/ci/` for CI/CD (normalized rendering)

### Golden Images Too Large

- Reduce widget dimensions in `SizedBox`
- Test only essential UI portions
- Consider using Git LFS for large golden files

## CI/CD Integration

Golden tests run automatically in CI:

```bash
flutter test --tags=golden
```

The CI environment uses normalized rendering via the `ci` platform configuration in `alchemist.yaml`, ensuring consistent results across different environments.

## Example Test

See `test/golden/widgets/placeholder_card_test.dart` for a working example of a basic golden test.

## Next Steps

As you build UI components for the MVP, add golden tests for:
- Transaction list items (TASK-0021)
- Transaction cards with various states
- Empty state widgets (TASK-0048)
- Form components (TASK-0014)
- Screen layouts (TASK-0020)

## Additional Resources

- [Alchemist Documentation](https://pub.dev/packages/alchemist)
- [Flutter Golden Testing Guide](https://docs.flutter.dev/testing/overview#golden-tests)
